#!/usr/bin/env python

from gdextension_build import ffmpeg_download
from gdextension_build import methods
from pathlib import Path
import os
import SCons

Import("env")

if not "RPATH" in env:
    env.Append(RPATH=env.Literal("\\$$ORIGIN"))

env_ffmpeg = env.Clone()


def _jal_emitter(target, source, env):
    print("EMITTER!!!")
    target += ["" + x for x in ffmpeg_download.get_ffmpeg_install_sources(os.path.dirname(target[0].get_path()))]
    print(target)
    return target, source


def Command2(env, target, source, action, **kw):
    """Builds the supplied target files from the supplied
    source files using the supplied action.  Action may
    be any type that the Builder constructor will accept
    for an action."""
    bkw = {"action": action, "target_factory": env.fs.Entry, "source_factory": env.fs.Entry, "emitter": _jal_emitter}

    bld = SCons.Builder.Builder(**bkw)
    return bld(env, target, source, **kw)


FFMPEG_DUMMY = "thirdparty/ffmpeg/LICENSE.txt"

ffmpeg_download_action = ffmpeg_download.ffmpeg_download_builder(
    env_ffmpeg, FFMPEG_DUMMY, "gdextension_build/ffmpeg_download.py"
)

module_obj = []

excluded = []

sources = [x for x in Glob("*.cpp") if str(x) not in excluded]

env_ffmpeg.Prepend(CPPPATH="thirdparty/ffmpeg/include")
env.Append(LIBPATH="thirdparty/ffmpeg/lib")
ffmpeg_libs = ["avcodec", "avfilter", "avformat", "avutil", "swresample", "swscale"]
env.Append(LIBS=ffmpeg_libs)

ffmpeg_install_action = ffmpeg_download.ffmpeg_install(env_ffmpeg, "#bin", "thirdparty/ffmpeg")
env_ffmpeg.Depends(ffmpeg_install_action, ffmpeg_download_action)
env_ffmpeg.Depends(sources, ffmpeg_install_action)

# env_ffmpeg.Append(CPPDEFINES=["FFMPEG_MT_GPU_UPLOAD"])
if ARGUMENTS.get("ffmpeg_shared", "no") == "yes":
    # Shared lib compilation
    env_ffmpeg.Append(CCFLAGS=["-fPIC"])
    env_ffmpeg["LIBS"] = FFMPEG_LIBS
    shared_lib = env_ffmpeg.SharedLibrary(target="#bin/ffmpeg", source=sources)
    shared_lib_shim = shared_lib[0].name.rsplit(".", 1)[0]
    env.Append(LIBPATH=["#bin"])
    env.Append(LIBS=[shared_lib_shim])
else:
    env_ffmpeg.add_source_files(module_obj, sources)
    env.modules_sources += module_obj
